TT_BLACKSMITH_HOME=$(pwd)

tt_forge_fe=false
tt_xla=false

while [[ "$#" -gt 0 ]]; do
    case $1 in
        --ffe) tt_forge_fe=true ;;
        --xla) tt_xla=true ;;
        *) echo "Unknown parameter passed: $1"; return 1 ;;
    esac
    shift
done

# if both are false, exit with error
if [ "$tt_forge_fe" = false ] && [ "$tt_xla" = false ]; then
    echo "No frontend was specified, please select one from: TT-XLA (--xla) or TT-Forge-FE (--ffe)"
    return 1
fi

export SYSTEM_DIST_PACKAGES="/usr/local/lib/python3.11/dist-packages"
export PYTHONPATH="$(pwd):$(pwd)/tests:$SYSTEM_DIST_PACKAGES"
# pytest alias for venv interpreter
alias pytest='python -m pytest'

# Set environment directory based on frontend
# To be safe we have two different environment directories for each frontend
if [ "$tt_forge_fe" = true ]; then
    export TT_BLACKSMITH_ENV_DIR=$TT_BLACKSMITH_HOME/env/ffe_env
    export TT_BLACKSMITH_FRONTEND="tt-forge-fe"
fi
if [ "$tt_xla" = true ]; then
    export TT_BLACKSMITH_ENV_DIR=$TT_BLACKSMITH_HOME/env/xla_env
    export TT_BLACKSMITH_FRONTEND="tt-xla"
fi

# If environment directory already exists, activate it
if [ -d $TT_BLACKSMITH_ENV_DIR/bin ]; then
    if [ -f $TT_BLACKSMITH_ENV_DIR/bin/activate ]; then
        source $TT_BLACKSMITH_ENV_DIR/bin/activate
    else
        echo "Virtual environment directory exists but does not contain activate script,"
        echo "please remove the $TT_BLACKSMITH_ENV_DIR directory and try again"
        return
    fi
    return
fi

# Otherwise create it
echo "Creating virtual environment in $TT_BLACKSMITH_ENV_DIR"
python3.11 -m venv $TT_BLACKSMITH_ENV_DIR
source $TT_BLACKSMITH_ENV_DIR/bin/activate
pip install --upgrade pip

# Install dependencies based on frontend
if [ "$tt_forge_fe" = true ]; then
    pip install -r env/ffe_requirements.txt -r env/requirements.txt
fi
if [ "$tt_xla" = true ]; then
    pip install -r env/xla_requirements.txt -r env/requirements.txt
fi

# Install base dependencies
pip install -e $TT_BLACKSMITH_HOME
